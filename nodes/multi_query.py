# nodes/multi_query.py
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_openai import ChatOpenAI
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LLM —á–µ—Ä–µ–∑ OpenRouter
llm = ChatOpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=os.getenv("OPENROUTER_API_KEY"),
    model="google/gemini-2.0-flash-001",
    temperature=0.0  # –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
)

# –ü—Ä–æ–º–ø—Ç: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 5 –Ω–∞—É—á–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –∑–∞–ø—Ä–æ—Å–∞
template = """–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –ø–æ —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—è—Ç—å
—Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. 

–°–æ–∑–¥–∞–≤–∞—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∞—à–∞ —Ü–µ–ª—å - –ø–æ–º–æ—á—å –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
–ø–æ–∏—Å–∫–∞ —Å—Ö–æ–¥—Å—Ç–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –Ω–∞—É—á–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –≤ —Å—Ç–∞—Ç—å—è—Ö –ø–æ –º–∞—à–∏–Ω–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é.

–ó–∞–¥–∞–≤–∞–π—Ç–µ —ç—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ä–∞–∑–¥–µ–ª—è—è –∏—Ö –Ω–æ–≤—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏. 
–ù–µ –Ω—É–º–µ—Ä—É–π—Ç–µ –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã.

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å: {question}
"""
prompt_perspectives = ChatPromptTemplate.from_template(template)

# –¶–µ–ø–æ—á–∫–∞: –ø—Ä–æ–º–ø—Ç ‚Üí LLM ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
generate_queries_chain = (
    prompt_perspectives
    | llm
    | StrOutputParser()
    | (lambda x: [q.strip() for q in x.split("\n") if q.strip()])
)

def multi_query(state):
    """
    –£–∑–µ–ª: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 5 –Ω–∞—É—á–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –≤–æ–ø—Ä–æ—Å–∞.
    –¶–µ–ª—å ‚Äî –ø–æ–≤—ã—Å–∏—Ç—å recall –≤ FAISS.
    """
    print("üîÅ –£–∑–µ–ª: Multi-Query ‚Äî Query Translation...")
    
    question = state.get("question")
    if not question:
        return {"queries": []}

    try:
        queries = generate_queries_chain.invoke({"question": question})
        print(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(queries)} –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:")
        for q in queries:
            print(f"   ‚Ä¢ '{q}'")
        
        return {"queries": queries}
    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤: {e}")
        return {"queries": [question]}